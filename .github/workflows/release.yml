name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.5.0)'
        required: true
        type: string

jobs:
  # First, run the full build to validate everything works
  build:
    uses: ./.github/workflows/build-reusable.yml

  # Then release
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/version = "[^"]*"/version = "${{ inputs.version }}"/' build.gradle.kts
          echo "Updated version to ${{ inputs.version }}"
          grep 'version = ' build.gradle.kts

      - name: Update version in README.md
        run: |
          # Update Gradle plugin version in examples: version "X.Y.Z"
          sed -i -E 's/version "[0-9]+\.[0-9]+\.[0-9]+"/version "${{ inputs.version }}"/g' README.md

          echo "Updated versions in README.md:"
          grep -E 'version "[0-9]+\.[0-9]+\.[0-9]+"' README.md || true

      - name: Build with new version
        run: ./gradlew clean build

      - name: Publish to Maven Central
        run: ./gradlew publishAndReleaseToMavenCentral
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}

      - name: Commit version change
        run: |
          git add build.gradle.kts
          git add README.md || true
          git commit -m "Release ${{ inputs.version }}"

      - name: Create and push tag
        run: |
          git tag "v${{ inputs.version }}"
          git push origin main
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --generate-notes \
            kotlin-plugin/build/libs/*.jar \
            kotlin-plugin-gradle/build/libs/*.jar

      - name: Set next development version
        run: |
          # Parse version and increment micro part
          VERSION="${{ inputs.version }}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          MICRO=$(echo "$VERSION" | cut -d. -f3)
          NEXT_MICRO=$((MICRO + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_MICRO}-SNAPSHOT"

          echo "Next development version: $NEXT_VERSION"

          # Update version in build.gradle.kts
          sed -i "s/version = \"$VERSION\"/version = \"$NEXT_VERSION\"/" build.gradle.kts
          grep 'version = ' build.gradle.kts

          # Commit and push
          git add build.gradle.kts
          git commit -m "Set next development version $NEXT_VERSION"
          git push origin main
